<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Visualizador 3D com Botões</title>

  <!-- Lógica para cache-buster dinâmico -->
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    // Prioriza o parâmetro 't' (timestamp) vindo do QR Code, senão usa um valor fixo (v=1.3)
    const cacheBuster = urlParams.get('t') ? `?t=${urlParams.get('t')}` : `?v=1.4`;
  </script>

  <!-- CSS externo com cache-buster dinâmico -->
  <link rel="stylesheet" id="app-css" />
  <script>
    document.getElementById('app-css').href = `../app/app.css${cacheBuster}`;
  </script>

  <!-- Bibliotecas A-Frame e AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: sans-serif;
    }
    .debug-text {
      display: none !important;
    }

    /* Barra de like/deslike (fica acima dos controles de navegação) */
    #likeBar {
      position: absolute;
      bottom: 140px; /* acima do nome do produto (80px) */
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 24px;
      z-index: 1100;
    }

    #likeBar button {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      border: none;
      background: rgba(0, 0, 0, 0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }

    #likeBar button img {
      max-width: 80%;
      max-height: 80%;
      pointer-events: none;
    }

    #likeBar button:active {
      transform: scale(0.9);
    }
  </style>

  <!-- CONFIGURAÇÃO DAS MÉTRICAS -->
  <script>
    (function () {
      const url = new URL(location.href);

      // URL base da API de métricas (HTTP API)
      const API_BASE = "https://zoci6wmxqa.execute-api.us-east-1.amazonaws.com";

      // Parâmetros vindos do QR / redirect:
      // Exemplo final de URL:
      // app.html?u=ranie.black29%40gmail.com&i=mesa1&v=123&restaurante=ranie-black29-gmail-com&t=1764...
      const tenant =
        url.searchParams.get("restaurante") ||
        url.searchParams.get("tenant") ||
        url.searchParams.get("r") ||
        url.searchParams.get("u") ||
        null;

      // Identificador lógico da mesa/QR (nome amigável ou código)
      const table =
        url.searchParams.get("mesa") ||
        url.searchParams.get("table") ||
        url.searchParams.get("i") ||
        null;

      // ID único do QR (se não vier explícito, cai no mesmo valor da "table")
      const qrId =
        url.searchParams.get("qrId") ||
        url.searchParams.get("qr") ||
        table ||
        null;

      window.__AR_METRICA_INIT = {
        endpoint: API_BASE + "/metricas/ingest",
        tenant: tenant,
        table: table,   // usado como qrLabel/mesa no dashboard
        qrId: qrId,     // ID estável do QR/mesa
        env: "prod",
        flushIntervalMs: 10000,
        maxBufferSize: 30,
        persistKey: "arcardapio_metrics_v3",
        sampleRate: 1.0,
        consentMetrics: true,
        heartbeatMs: 30000
      };
    })();
  </script>
</head>

<body>

  <!-- Botão de menu -->
  <button id="menuBtn">Cardápio</button>

  <!-- Botões de categoria -->
  <div id="categoryButtons" style="display: none">
    <button class="category-btn" onclick="selectCategory('bebidas')">Bebidas</button>
    <button class="category-btn" onclick="selectCategory('pizzas')">Pizzas</button>
    <button class="category-btn" onclick="selectCategory('sobremesas')">Sobremesas</button>
    <button class="category-btn" onclick="selectCategory('carnes')">Carnes</button>
    <button class="category-btn" onclick="selectCategory('lanches')">Lanches</button>
    <button class="category-btn" onclick="selectCategory('porcoes')">Porções</button>
  </div>

  <!-- Indicador de carregamento -->
  <div id="loadingIndicator">Carregando...</div>

  <!-- Exibe o preço -->
  <div id="priceDisplay">R$ 0,00</div>

  <!-- Nome do produto -->
  <div
    id="productNameDisplay"
    style="
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #e0e0e0;
      color: #000;
      padding: 6px 16px;
      border-radius: 12px;
      font-size: 1.1em;
      font-weight: 500;
      z-index: 1000;
    "
  ></div>

  <!-- Barra de Like / Deslike (negativo à esquerda, positivo à direita) -->
  <!-- Barra de Like / Deslike -->
  <div id="likeBar">
    <button id="btnDislike" class="like-btn like-left" aria-label="Não gostei">
      <img src="../imagens/negativo.png" alt="Não gostei">
    </button>

    <button id="btnLike" class="like-btn like-right" aria-label="Gostei">
      <img src="../imagens/positivo.png" alt="Gostei">
    </button>
  </div>


  <!-- Botões para navegar entre os modelos -->
  <button id="prevBtn" class="btn" onclick="changeModel(-1)">
    <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" /></svg>
  </button>
  <button id="nextBtn" class="btn" onclick="changeModel(1)">
    <svg viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z" /></svg>
  </button>

  <!-- Botão Info -->
  <button id="infoBtn" class="btn" onclick="toggleInfo()" style="display: none;">ℹ️ Info</button>

  <!-- Painel de informações -->
  <div
    id="infoPanel"
    style="
      display: none;
      position: absolute;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      width: 80vw;
      max-height: 60vh;
      overflow-y: auto;
      background-color: rgba(255, 255, 255, 0.95);
      color: #000;
      padding: 16px 20px;
      border-radius: 16px;
      font-size: 1em;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      text-align: left;
    "
  >
    <button
      onclick="document.getElementById('infoPanel').style.display='none'"
      style="
        position: absolute;
        top: 8px;
        right: 12px;
        background: transparent;
        border: none;
        font-size: 1.2em;
        cursor: pointer;
      "
    >✖</button>
    <div id="infoContent">Carregando...</div>
  </div>

  <!-- Cena AR -->
  <a-scene embedded vr-mode-ui="enabled: false" arjs="sourceType: webcam; debugUIEnabled: false;">
    <a-entity
      id="modelContainer"
      rotation="0 180 0"
      position="0 0 0"
      scale="1 1 1"
      gltf-model=""
      gesture-detector
      grabbable
      draggable
      touch-action="none"
      crossorigin="anonymous"
    ></a-entity>
    <a-camera position="0 1.5 3"></a-camera>
  </a-scene>

  <!-- Scripts do projeto com cache-buster dinâmico -->
  <script>
    document.write(`<script src="../app/models.js${cacheBuster}"><\/script>`);
    document.write(`<script src="../app/app.js${cacheBuster}"><\/script>`);
    document.write(`<script src="../app/metricaapp.js${cacheBuster}"><\/script>`);
  </script>

  <!-- INTEGRAÇÃO DE MÉTRICAS + LIKE/DESLIKE -->
  <script>
    // Deixa o SDK inicializar sozinho (metricaapp.js já faz isso usando __AR_METRICA_INIT)
    // Aqui só ligamos o autoBind depois do load.
    window.addEventListener("load", function () {
      if (window.MetricaApp) {
        try { MetricaApp.autoBind(); } catch (e) { console.error(e); }
      }
    });

    // Controle do painel Info (compatível com o SDK)
    (function () {
      const panel = document.getElementById("infoPanel");
      const btn = document.getElementById("infoBtn");

      window.toggleInfo = function () {
        if (!panel) return;
        const visible = panel.style.display !== "none" && panel.style.display !== "";
        if (visible) {
          panel.style.display = "none";
          panel.classList.remove("open", "show");
        } else {
          panel.style.display = "block";
          panel.classList.add("open");
        }
      };

      if (btn) btn.addEventListener("click", toggleInfo, { passive: true });
    })();

    // Integração com mudança de modelo (para medir tempo de visualização por item)
    (function () {
      const originalChangeModel = window.changeModel;
      window.changeModel = function (dir) {
        if (typeof originalChangeModel === "function") {
          const next = originalChangeModel(dir) || {};
          if (window.MetricaApp && (next.id || next.name)) {
            try {
              MetricaApp.setCurrentItem({
                id: next.id ?? null,
                name:
                  next.name ??
                  (document.getElementById("productNameDisplay")?.textContent?.trim() || null),
                category: next.category ?? null,
                price: next.price ?? null
              });
            } catch (e) {
              console.error(e);
            }
          }
          return next;
        }
      };
    })();

    // Integração com seleção de categoria
    (function () {
      const originalSelectCategory = window.selectCategory;
      window.selectCategory = function (cat) {
        if (typeof originalSelectCategory === "function") {
          originalSelectCategory(cat);
        }
        if (window.MetricaApp) {
          try { MetricaApp.trackEvent("category_select", { category: cat }); }
          catch (e) { console.error(e); }
        }
      };
    })();

    // Botões de like / deslike (ícones acima do botão de troca de objeto)
    (function () {
      const btnLike = document.getElementById("btnLike");
      const btnDislike = document.getElementById("btnDislike");

      if (!btnLike || !btnDislike) return;

      btnLike.addEventListener("click", function () {
        console.log("[AR-LIKE] positivo");
        if (window.MetricaApp && typeof MetricaApp.trackEvent === "function") {
          try {
            MetricaApp.trackEvent("like", { value: "positivo" });
          } catch (e) {
            console.error(e);
          }
        }
      });

      btnDislike.addEventListener("click", function () {
        console.log("[AR-LIKE] negativo");
        if (window.MetricaApp && typeof MetricaApp.trackEvent === "function") {
          try {
            MetricaApp.trackEvent("like", { value: "negativo" });
          } catch (e) {
            console.error(e);
          }
        }
      });
    })();
  </script>
</body>
</html>
